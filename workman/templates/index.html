<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WORKMAN çˆ¬èŸ² (Bulk Operations)</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #d32f2f; }
        .card { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-work { background: #1976d2; color: white; }
        .btn-mens { background: #388e3c; color: white; }
        .btn-womens { background: #d81b60; color: white; }
        .btn-kids { background: #f57c00; color: white; }
        .btn-all { background: #7b1fa2; color: white; }
        .btn-upload { background: #d32f2f; color: white; font-size: 18px; padding: 15px 30px; }
        .btn-check { background: #455a64; color: white; }
        .btn-delete { background: #b71c1c; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        #status { padding: 15px; background: #e3f2fd; border-radius: 8px; margin: 15px 0; }
        #log { height: 300px; overflow-y: auto; background: #263238; color: #aed581; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; }
        .progress { height: 8px; background: #e0e0e0; border-radius: 4px; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); border-radius: 4px; transition: width 0.3s; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f5f5f5; }
        .phase { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .phase-scraping { background: #fff3e0; color: #e65100; }
        .phase-uploading { background: #e3f2fd; color: #1565c0; }
        .phase-deleting { background: #ffebee; color: #c62828; }
        .phase-completed { background: #e8f5e9; color: #2e7d32; }
        .warning-box { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ­ WORKMAN çˆ¬èŸ² (Bulk Operations ç‰ˆ)</h1>
    
    <div class="card" style="border: 2px solid #ff9800; background: #fff8e1;">
        <h3>ğŸ”„ åº«å­˜åŒæ­¥</h3>
        <p>æª¢æŸ¥ WORKMAN å®˜ç¶²åº«å­˜ç‹€æ…‹ï¼Œè‡ªå‹•å°‡ç¼ºè²¨å•†å“è¨­ç‚ºè‰ç¨¿ä¸¦åº«å­˜æ­¸é›¶ã€‚</p>
        <p style="font-size:13px;color:#666;">åˆ¤æ–·æ¢ä»¶ï¼šã€Œåº—èˆ—ã®ã¿ã®ãŠå–ã‚Šæ‰±ã„ã€ã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆã‚¢è²©å£²çµ‚äº†ã€ã€Œåº—èˆ—åœ¨åº«ã‚’ç¢ºèªã™ã‚‹ã€ã€Œå£²ã‚Šåˆ‡ã‚Œã€ã€Œå“åˆ‡ã‚Œã€ã€Œé é¢ 404ã€</p>
        <button class="btn" style="background:#ff9800;color:white;font-size:18px;padding:15px 30px;" onclick="startInventorySync()">ğŸ”„ é–‹å§‹åº«å­˜åŒæ­¥</button>
        <button class="btn btn-check" onclick="checkInventorySyncStatus()">ğŸ“Š æŸ¥çœ‹åŒæ­¥ç‹€æ…‹</button>
        <button class="btn btn-check" onclick="checkSingleStock()">ğŸ” æª¢æŸ¥å–®ä¸€å•†å“</button>
        <div id="syncResult" style="margin-top:10px;padding:10px;background:#fff;border-radius:5px;display:none;"></div>
    </div>
    
    <div class="card">
        <h3>ğŸ”— é€£ç·šæ¸¬è©¦</h3>
        <button class="btn btn-check" onclick="testConnection()">ğŸ”— æ¸¬è©¦ workman.jp</button>
        <button class="btn btn-check" onclick="testProductParse()">ğŸ” æ¸¬è©¦å•†å“è§£æ</button>
        <button class="btn btn-check" onclick="testShopify()">ğŸ”— æ¸¬è©¦ Shopify</button>
    </div>
    
    <div class="card" style="border: 2px solid #28a745; background: #f0fff4;">
        <h3>ğŸ§ª æ¸¬è©¦å–®å“ï¼ˆå¿«é€Ÿé©—è­‰ï¼‰</h3>
        <button class="btn" style="background:#28a745;color:white;" onclick="testSingle()">ğŸ§ª æ¸¬è©¦å–®å“ä¸Šå‚³</button>
        <button class="btn btn-check" onclick="checkTestResult()">ğŸ“‹ æŸ¥çœ‹æ¸¬è©¦çµæœ</button>
        <div id="testResult" style="margin-top:10px;padding:10px;background:#fff;border-radius:5px;display:none;"></div>
    </div>
    
    <div class="card">
        <h3>ğŸ“¥ ç¬¬ä¸€æ­¥ï¼šçˆ¬å–å•†å“ â†’ ç”¢ç”Ÿ JSONL</h3>
        <button class="btn btn-work" onclick="startScrape('work')">ğŸ”§ ä½œæ¥­æœ</button>
        <button class="btn btn-mens" onclick="startScrape('mens')">ğŸ‘” ç”·è£</button>
        <button class="btn btn-womens" onclick="startScrape('womens')">ğŸ‘— å¥³è£</button>
        <button class="btn btn-kids" onclick="startScrape('kids')">ğŸ‘¶ å…’ç«¥æœ</button>
        <button class="btn btn-all" onclick="startScrape('all')">ğŸš€ å…¨éƒ¨</button>
    </div>
    
    <div class="card">
        <h3>ğŸ“¤ ç¬¬äºŒæ­¥ï¼šæ‰¹é‡ä¸Šå‚³åˆ° Shopify</h3>
        <div style="margin:10px 0;padding:10px;background:#e8f5e9;border-radius:8px;">
            <label><input type="checkbox" id="autoPublish" checked> <strong>ä¸Šå‚³å®Œæˆå¾Œè‡ªå‹•ç™¼å¸ƒ</strong></label>
        </div>
        <button class="btn btn-upload" id="uploadBtn" onclick="startUpload()" disabled>ğŸ“¤ æ‰¹é‡ä¸Šå‚³</button>
        <button class="btn btn-check" onclick="checkStatus()">ğŸ” æª¢æŸ¥ä¸Šå‚³ç‹€æ…‹</button>
        <button class="btn btn-check" onclick="checkResults()">ğŸ“‹ æŸ¥çœ‹è©³ç´°çµæœ</button>
    </div>
    
    <div class="card">
        <h3>ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤</h3>
        <div class="warning-box">âš ï¸ æœƒåˆªé™¤æ‰€æœ‰ WORKMAN å•†å“ï¼</div>
        <button class="btn btn-delete" onclick="startDelete()">ğŸ—‘ï¸ åˆªé™¤å…¨éƒ¨</button>
        <button class="btn btn-check" onclick="countProducts()">ğŸ“Š æŸ¥è©¢æ•¸é‡</button>
    </div>
    
    <div class="card">
        <h3>ğŸ“¢ ç™¼å¸ƒåˆ°éŠ·å”®ç®¡é“</h3>
        <button class="btn btn-upload" onclick="publishAll()">ğŸ“¢ ç™¼å¸ƒæ‰€æœ‰å•†å“</button>
        <button class="btn btn-check" onclick="getPublications()">ğŸ“‹ æŸ¥çœ‹éŠ·å”®ç®¡é“</button>
    </div>
    
    <div class="card">
        <h3>ğŸ“Š åŸ·è¡Œç‹€æ…‹</h3>
        <div id="status">ç­‰å¾…é–‹å§‹...</div>
        <div class="progress"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
    </div>
    
    <div class="card">
        <h3>ğŸ“‹ åŸ·è¡Œè¨˜éŒ„</h3>
        <div id="log"></div>
    </div>
    
<script>
let currentJsonlFile = '';
let lastProductCount = 0, lastProgress = 0, lastPhase = '', lastErrorCount = 0;

// ===== åº«å­˜åŒæ­¥ =====
function startInventorySync() {
    if (!confirm('ç¢ºå®šè¦é–‹å§‹åº«å­˜åŒæ­¥ï¼Ÿ')) return;
    log('ğŸ”„ é–‹å§‹åº«å­˜åŒæ­¥...'); document.getElementById('status').textContent = 'åº«å­˜åŒæ­¥ä¸­...';
    fetch('/api/inventory_sync').then(r=>r.json()).then(d=>{
        if(d.error) log('âŒ '+d.error); else { log('ğŸ”„ å·²å•Ÿå‹•'); pollInventorySyncStatus(); }
    });
}
function pollInventorySyncStatus() {
    fetch('/api/inventory_sync_status').then(r=>r.json()).then(d=>{
        let s = d.current_product||'è™•ç†ä¸­...';
        if(d.total>0) s+=' ('+d.progress+'/'+d.total+')';
        document.getElementById('status').textContent = s;
        if(d.total>0) document.getElementById('progressBar').style.width=(d.progress/d.total*100)+'%';
        if(d.running) setTimeout(pollInventorySyncStatus,2000);
        else if(d.phase==='completed') {
            let r=d.results;
            log('âœ… åº«å­˜åŒæ­¥å®Œæˆï¼æª¢æŸ¥:'+r.checked+' æœ‰è²¨:'+r.in_stock+' ç¼ºè²¨:'+r.out_of_stock+' è‰ç¨¿:'+r.draft_set+' æ­¸é›¶:'+r.inventory_zeroed);
            showSyncDetails(d);
        } else if(d.phase==='error') log('âŒ åº«å­˜åŒæ­¥å¤±æ•—');
    });
}
function checkInventorySyncStatus() {
    fetch('/api/inventory_sync_status').then(r=>r.json()).then(d=>{
        if(d.phase==='completed') { let r=d.results; log('ğŸ“Š ä¸Šæ¬¡: æª¢æŸ¥'+r.checked+' æœ‰è²¨'+r.in_stock+' ç¼ºè²¨'+r.out_of_stock+' è‰ç¨¿'+r.draft_set); showSyncDetails(d); }
        else if(d.running) log('ğŸ”„ åŒæ­¥ä¸­: '+d.progress+'/'+d.total);
        else log('ğŸ“Š å°šæœªåŸ·è¡Œåº«å­˜åŒæ­¥');
    });
}
function showSyncDetails(data) {
    let div=document.getElementById('syncResult');
    if(!data.details||!data.details.length){div.style.display='none';return;}
    let oos=data.details.filter(d=>d.status!=='in_stock');
    let html='<h4>åŒæ­¥è©³æƒ…</h4><table><tr><th>å•†å“</th><th>ç‹€æ…‹</th><th>åŸå› </th></tr>';
    if(!oos.length) html+='<tr><td colspan="3">ğŸ‰ æ‰€æœ‰å•†å“éƒ½æœ‰è²¨ï¼</td></tr>';
    else oos.forEach(d=>{html+='<tr><td>'+d.title+'</td><td>'+(d.status==='page_gone'?'ğŸš«':'âŒ')+' '+d.status+'</td><td>'+(d.reason||'')+'</td></tr>';});
    html+='</table><p style="font-size:12px;color:#666;">'+oos.length+' å€‹ç¼ºè²¨ / '+data.details.length+' å€‹å·²æª¢æŸ¥</p>';
    div.innerHTML=html; div.style.display='block';
}
function checkSingleStock() {
    let url=prompt('è«‹è¼¸å…¥ WORKMAN å•†å“ URLï¼š\nä¾‹å¦‚: https://workman.jp/shop/g/g2300068265020/');
    if(!url) return; log('ğŸ” æª¢æŸ¥: '+url);
    fetch('/api/check_stock?url='+encodeURIComponent(url)).then(r=>r.json()).then(d=>{
        if(d.available) log('âœ… æœ‰è²¨ï¼'); else log('âŒ ç¼ºè²¨: '+(d.out_of_stock_reason||'æœªçŸ¥'));
        log('   é é¢å­˜åœ¨: '+(d.page_exists?'æ˜¯':'å¦'));
    });
}

// ===== çˆ¬å–èˆ‡ä¸Šå‚³ =====
function startScrape(cat) {
    if(!confirm('ç¢ºå®šçˆ¬å– '+cat+'ï¼Ÿ')) return;
    resetTracking(); document.getElementById('uploadBtn').disabled=true; document.getElementById('log').innerHTML='';
    fetch('/api/start?category='+cat).then(r=>r.json()).then(()=>{log('ğŸš€ é–‹å§‹çˆ¬å–: '+cat); pollStatus();});
}
function startUpload() {
    if(!currentJsonlFile){alert('è«‹å…ˆå®Œæˆçˆ¬å–ï¼');return;} if(!confirm('ç¢ºå®šä¸Šå‚³ï¼Ÿ')) return;
    resetTracking();
    fetch('/api/upload?file='+encodeURIComponent(currentJsonlFile)).then(r=>r.json()).then(()=>{log('ğŸš€ é–‹å§‹ä¸Šå‚³...'); pollStatus(); setTimeout(pollBulkStatus,5000);});
}
function pollBulkStatus() {
    fetch('/api/bulk_status').then(r=>r.json()).then(d=>{
        let s=d.status||'UNKNOWN';
        document.getElementById('status').textContent='Bulk: '+s+', è™•ç†:'+d.objectCount;
        if(s==='COMPLETED'){log('âœ… ä¸Šå‚³å®Œæˆï¼'); if(document.getElementById('autoPublish').checked){log('ğŸ“¢ è‡ªå‹•ç™¼å¸ƒ...'); publishAll(true);}}
        else if(s==='FAILED'||s==='CANCELED') log('âŒ å¤±æ•—: '+s);
        else if(s==='RUNNING'||s==='CREATED') setTimeout(pollBulkStatus,3000);
    });
}
function checkStatus() {
    fetch('/api/bulk_status').then(r=>r.json()).then(d=>{
        log('ğŸ“Š Bulk: '+d.status+', è™•ç†:'+d.objectCount);
        if(d.status==='COMPLETED'&&document.getElementById('autoPublish').checked) publishAll(true);
    });
}
function checkResults() {
    fetch('/api/bulk_results').then(r=>r.json()).then(d=>{
        log('ğŸ“Š ç‹€æ…‹:'+d.status+' ç¸½æ•¸:'+d.objectCount);
        if(d.success_count!==undefined) log('âœ…'+d.success_count+' âŒ'+d.error_count);
    });
}
function startDelete() {
    if(!confirm('âš ï¸ ç¢ºå®šåˆªé™¤æ‰€æœ‰ WORKMAN å•†å“ï¼Ÿ')) return;
    if(!confirm('å†æ¬¡ç¢ºèªï¼Ÿ')) return;
    resetTracking();
    fetch('/api/delete').then(r=>r.json()).then(d=>{if(d.error) log('âŒ '+d.error); else {log('ğŸ—‘ï¸ é–‹å§‹åˆªé™¤...'); pollStatus();}});
}
function countProducts() {
    fetch('/api/count').then(r=>r.json()).then(d=>{log('ğŸ“Š '+d.count+' å€‹ WORKMAN å•†å“');});
}
function publishAll(auto) {
    if(!auto&&!confirm('ç¢ºå®šç™¼å¸ƒï¼Ÿ')) return;
    log('ğŸ“¢ ç™¼å¸ƒä¸­...');
    fetch('/api/publish_all').then(r=>r.json()).then(d=>{
        if(d.error) log('âŒ '+d.error);
        else log('ğŸ“¢ ç™¼å¸ƒå®Œæˆï¼æˆåŠŸ:'+d.success+' å¤±æ•—:'+d.failed);
    });
}
function getPublications() {
    fetch('/api/publications').then(r=>r.json()).then(d=>{
        if(d.publications) d.publications.forEach(p=>log('   - '+p.name));
    });
}
function testConnection() {
    log('ğŸ”— æ¸¬è©¦ workman.jp...');
    fetch('/api/test_workman').then(r=>r.json()).then(d=>{
        if(d.homepage&&d.homepage.ok) log('âœ… ä¸»é OK'); else log('âŒ ä¸»é å¤±æ•—');
        if(d.kids_page&&d.kids_page.ok) log('âœ… åˆ†é¡é OK, æ‰¾åˆ°'+d.kids_page.goods_links_found+'å€‹å•†å“'); else log('âŒ åˆ†é¡é å¤±æ•—');
    });
}
function testProductParse() {
    fetch('/api/test_product').then(r=>r.json()).then(d=>{
        log('ğŸ“„ '+d.url+' HTTP:'+d.status);
        if(d.title_found) log('âœ… æ¨™é¡Œ:'+d.title); if(d.price_elem_found) log('âœ… åƒ¹æ ¼:'+d.price_text);
    });
}
function testShopify() {
    fetch('/api/test').then(r=>r.json()).then(d=>{
        if(d.data&&d.data.shop) log('âœ… Shopify: '+d.data.shop.name); else log('âŒ Shopify å¤±æ•—');
    });
}
function testSingle() {
    if(!confirm('æ¸¬è©¦å–®å“ä¸Šå‚³ï¼Ÿ')) return; log('ğŸ§ª æ¸¬è©¦ä¸­...');
    fetch('/api/test_single').then(r=>r.json()).then(()=>pollTestStatus());
}
function pollTestStatus() {
    fetch('/api/status').then(r=>r.json()).then(d=>{
        document.getElementById('status').textContent=d.current_product||'';
        if(d.running) setTimeout(pollTestStatus,1000); else checkTestResult();
    });
}
function checkTestResult() {
    fetch('/api/test_result').then(r=>r.json()).then(d=>{
        let div=document.getElementById('testResult'); div.style.display='block';
        if(d.errors&&d.errors.length) div.innerHTML='<b style="color:red">âŒ '+d.errors.map(e=>e.error).join('<br>')+'</b>';
        else if(d.test_result&&d.test_result.id) {let r=d.test_result; div.innerHTML='<b style="color:green">âœ… æˆåŠŸ!</b><br>'+r.title+'<br>Handle: '+r.handle+'<br>ç™¼å¸ƒ: '+r.published+'å€‹ç®¡é“'; log('âœ… '+r.title);}
        else div.innerHTML='â³ å°šç„¡çµæœ';
    });
}

// ===== é€šç”¨ =====
function resetTracking() { lastProductCount=0; lastProgress=0; lastPhase=''; lastErrorCount=0; }
function pollStatus() {
    fetch('/api/status').then(r=>r.json()).then(d=>{updateUI(d); if(d.running) setTimeout(pollStatus,1000);});
}
function updateUI(d) {
    let pt={scraping:'çˆ¬å–ä¸­',uploading:'ä¸Šå‚³ä¸­',deleting:'åˆªé™¤ä¸­',completed:'å®Œæˆ'}[d.phase]||d.phase;
    if(d.phase!==lastPhase) { log('ğŸ“Œ '+pt); lastPhase=d.phase; }
    let h='<span class="phase phase-'+d.phase+'">'+pt+'</span> '+(d.current_product||'');
    if(d.total>0) h+='<br>é€²åº¦: '+d.progress+'/'+d.total+' ('+(d.progress/d.total*100).toFixed(1)+'%)';
    if(d.jsonl_file) { h+='<br>ğŸ“„ '+d.jsonl_file.split('/').pop(); currentJsonlFile=d.jsonl_file; document.getElementById('uploadBtn').disabled=false; }
    if(d.bulk_operation_id) h+='<br>ğŸ”„ '+d.bulk_operation_id.split('/').pop()+' '+d.bulk_status;
    if(d.errors.length) h+='<br>âš ï¸ éŒ¯èª¤: '+d.errors.length;
    document.getElementById('status').innerHTML=h;
    document.getElementById('progressBar').style.width=(d.total>0?d.progress/d.total*100:0)+'%';
    if(d.progress>lastProgress&&d.progress%10===0) log('ğŸ“Š '+d.progress+'/'+d.total);
    lastProgress=d.progress;
    if(d.products.length>lastProductCount) d.products.slice(lastProductCount).forEach(p=>log('âœ“ '+p.title));
    lastProductCount=d.products.length;
    if(d.errors.length>lastErrorCount) d.errors.slice(lastErrorCount).forEach(e=>log('âŒ '+(e.error||e.url)));
    lastErrorCount=d.errors.length;
}
function log(msg) {
    let div=document.getElementById('log'), t=new Date().toLocaleTimeString();
    div.innerHTML='['+t+'] '+msg+'\n'+div.innerHTML;
}
pollStatus();
</script>
</body>
</html>
